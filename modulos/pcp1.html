<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProduSIM - M√≥dulo PCP1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .simulation-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .decision-panel {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .result-panel {
            background-color: white;
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .validation-success {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .validation-warning {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .validation-error {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .period-nav {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .financial-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 15px;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-speedometer2 me-2"></i>ProduSIM - PCP1
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-inicio"><i class="bi bi-house-door me-1"></i>In√≠cio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-demanda"><i class="bi bi-graph-up me-1"></i>Demanda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-producao"><i class="bi bi-gear me-1"></i>Produ√ß√£o</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-compras"><i class="bi bi-cart me-1"></i>Compras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-capacidade"><i class="bi bi-building me-1"></i>Capacidade</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-financeiro"><i class="bi bi-currency-dollar me-1"></i>Financeiro</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-relatorios"><i class="bi bi-clipboard-data me-1"></i>Relat√≥rios</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" id="btn-close-period" type="button">
                        <i class="bi bi-check2-circle me-1"></i>Fechar Per√≠odo
                    </button>
                    <button class="btn btn-outline-light me-2" id="btn-save">
                        <i class="bi bi-save me-1"></i>Salvar
                    </button>
                    <button class="btn btn-outline-light" id="btn-reset">
                        <i class="bi bi-trash me-1"></i>Limpar Dados
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-fill">
    <div class="container mt-4">
        <!-- Tela de In√≠cio/Cadastro -->
    <div id="tela-inicio" class="content-section">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Cadastro do Grupo</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="empresa" class="form-label">Nome da Empresa</label>
                                <input type="text" class="form-control" id="empresa" placeholder="Digite o nome da empresa">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Integrantes do Grupo</label>
                                <input type="text" class="form-control mb-2" id="integrante1" placeholder="Integrante 1">
                                <input type="text" class="form-control mb-2" id="integrante2" placeholder="Integrante 2">
                                <input type="text" class="form-control mb-2" id="integrante3" placeholder="Integrante 3">
                                <input type="text" class="form-control mb-2" id="integrante4" placeholder="Integrante 4">
                                <input type="text" class="form-control" id="integrante5" placeholder="Integrante 5">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Demanda</label>
                                <select class="form-select" id="tipo-demanda">
                                    <option value="alta">Demanda Alta (Mercado de Massa)</option>
                                    <option value="media">Demanda M√©dia (Repetitivo em Lotes)</option>
                                    <option value="baixa">Demanda Baixa (Sob Encomenda)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tamanho da Empresa</label>
                                <select class="form-select" id="tamanho-empresa">
                                    <option value="pequena">Pequena</option>
                                    <option value="media">M√©dia</option>
                                    <option value="grande">Grande</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="modo-professor">
                                    <label class="form-check-label" for="modo-professor">Modo Avan√ßado (configurar cen√°rio)</label>
                                </div>
                            </div>
                            <div class="collapse" id="painel-cenario">
                                <div class="card card-body mb-3">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Volatilidade Demanda (%)</label>
                                            <input type="number" class="form-control" id="cen-vol" value="20">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Custo Estoque (un)</label>
                                            <input type="number" class="form-control" id="cen-cust-estoque" value="2">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Penalidade Venda Perdida (un)</label>
                                            <input type="number" class="form-control" id="cen-penalidade" value="5">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Custos Fixos (per√≠odo)</label>
                                            <input type="number" class="form-control" id="cen-custos-fixos" value="5000">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Pre√ßo Colmeia</label>
                                            <input type="number" class="form-control" id="preco-colmeia" value="20">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Pre√ßo Piquet</label>
                                            <input type="number" class="form-control" id="preco-piquet" value="28">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Pre√ßo Maxim</label>
                                            <input type="number" class="form-control" id="preco-maxim" value="35">
                                        </div>
                                    </div>
                                    <hr>
                                    <h6 class="mb-3"><i class="bi bi-graph-up me-2"></i>Padr√µes de Demanda por Produto</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Padr√£o Colmeia</label>
                                            <select class="form-select" id="pattern-colmeia">
                                                <option value="linear">Linear/Est√°vel (padr√£o)</option>
                                                <option value="growing">Crescente</option>
                                                <option value="declining">Decrescente</option>
                                            </select>
                                            <small class="text-muted">Produto tradicionalmente est√°vel</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Padr√£o Piquet</label>
                                            <select class="form-select" id="pattern-piquet">
                                                <option value="linear">Linear/Est√°vel</option>
                                                <option value="growing" selected>Crescente (padr√£o)</option>
                                                <option value="declining">Decrescente</option>
                                            </select>
                                            <small class="text-muted">Produto em crescimento no mercado</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Padr√£o Maxim</label>
                                            <select class="form-select" id="pattern-maxim">
                                                <option value="linear">Linear/Est√°vel</option>
                                                <option value="growing">Crescente</option>
                                                <option value="declining" selected>Decrescente (padr√£o)</option>
                                            </select>
                                            <small class="text-muted">Produto maduro com decl√≠nio</small>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Multiplicador Colmeia</label>
                                            <input type="number" class="form-control" id="vol-colmeia" value="0.75" min="0.25" max="3.0" step="0.05">
                                            <small class="text-muted">Base 20% √ó 0.75 = 15%</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Multiplicador Piquet</label>
                                            <input type="number" class="form-control" id="vol-piquet" value="1.25" min="0.25" max="3.0" step="0.05">
                                            <small class="text-muted">Base 20% √ó 1.25 = 25%</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Multiplicador Maxim</label>
                                            <input type="number" class="form-control" id="vol-maxim" value="1.75" min="0.25" max="3.0" step="0.05">
                                            <small class="text-muted">Base 20% √ó 1.75 = 35%</small>
                                        </div>
                                    </div>
                                    <small class="text-muted">Os demais par√¢metros usam valores padr√£o e podem ser ajustados no c√≥digo conforme necess√°rio.</small>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-success" id="btn-iniciar-jogo" type="button">
                                    <i class="bi bi-play-circle me-1"></i>Iniciar Jogo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demais telas ser√£o carregadas dinamicamente -->
    <div id="tela-demanda" class="content-section d-none"></div>

        <div id="tela-producao" class="content-section d-none">
            <!-- Conte√∫do da tela de produ√ß√£o -->
        </div>

        <div id="tela-compras" class="content-section d-none">
            <!-- Conte√∫do da tela de compras -->
        </div>

        <div id="tela-capacidade" class="content-section d-none">
            <!-- Conte√∫do da tela de capacidade -->
        </div>

        <div id="tela-financeiro" class="content-section d-none">
            <!-- Conte√∫do da tela financeiro -->
        </div>

        <div id="tela-relatorios" class="content-section d-none">
            <!-- Conte√∫do da tela de relat√≥rios -->
        </div>
    </div>
    </main>

        <footer class="bg-dark text-light mt-auto py-3">
                <div class="container">
                        <div class="row align-items-center">
                                <div class="col-md-6">
                                        <p class="mb-0">ProduSIM - Sistema de Simula√ß√£o de PCP</p>
                                        <p class="mb-0">Desenvolvido por Carlos Henrique (LABINFO/FAEN/UFGD) - 2025</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                        <p class="mb-0">Vers√£o 1.0.0 - M√≥dulo PCP1</p>
                                        <p class="mb-0">Baseado no LSSP_PCP da UFSC</p>
                                        <button type="button" class="btn btn-outline-light btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#modalRegras">
                                                <i class="bi bi-info-circle"></i> Regras do Jogo
                                        </button>
                                </div>
                        </div>
                </div>
        </footer>

        <!-- Modal Regras do Jogo -->
        <div class="modal fade" id="modalRegras" tabindex="-1" aria-labelledby="modalRegrasLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalRegrasLabel"><i class="bi bi-info-circle me-2"></i>Regras do Jogo</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Objetivo</h6>
                        <p>O objetivo do jogo √© maximizar o <strong>Resultado Acumulado</strong> (lucro total) ao final do per√≠odo 24, mantendo um <strong>N√≠vel de Servi√ßo</strong> elevado (m√≠nimo recomendado: 90%).</p>
                        <h6>Como Jogar</h6>
                        <ul>
                            <li><strong>Previs√£o de Demanda:</strong> Use a Demanda Base como refer√™ncia e ajuste conforme o hist√≥rico. Reduza erros de previs√£o.</li>
                            <li><strong>Produ√ß√£o:</strong> Planeje dentro da capacidade dispon√≠vel. Produzir acima da capacidade gera terceiriza√ß√£o (custo extra).</li>
                            <li><strong>Compras:</strong> Compre insumos conforme o plano de produ√ß√£o e o BOM. Evite estoques excessivos.</li>
                            <li><strong>Servi√ßo:</strong> Busque atender a demanda sem gerar perdas de venda, mas sem inflar estoques.</li>
                            <li><strong>Fechamento:</strong> Ao fechar o per√≠odo, confira o Financeiro. Investigue quedas no resultado operacional.</li>
                        </ul>
                        <h6>Crit√©rio de Vit√≥ria</h6>
                        <ul>
                            <li>Vence o grupo com maior <strong>Resultado Acumulado</strong> no per√≠odo 24.</li>
                            <li>Em caso de empate, vence quem tiver maior <strong>N√≠vel de Servi√ßo</strong> acumulado.</li>
                        </ul>
                        <h6>Dicas</h6>
                        <ul>
                            <li>Evite terceiriza√ß√£o e perdas de venda para maximizar o lucro.</li>
                            <li>Estoques altos geram custos extras; estoques baixos podem causar perdas de venda.</li>
                            <li>Use os relat√≥rios e gr√°ficos para ajustar sua estrat√©gia a cada per√≠odo.</li>
                        </ul>
                        <h6>üìä Padr√µes de Demanda (Baseado no LSSP Original)</h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="card border-primary h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-primary">COLMEIA</h6>
                                        <p class="card-text small mb-1">
                                            <strong>Padr√£o:</strong> Linear/Est√°vel<br>
                                            <strong>Volatilidade:</strong> Baixa (15%)<br>
                                            <strong>Caracter√≠stica:</strong> Produto tradicional com demanda previs√≠vel
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-success">PIQUET</h6>
                                        <p class="card-text small mb-1">
                                            <strong>Padr√£o:</strong> Crescente<br>
                                            <strong>Volatilidade:</strong> M√©dia (25%)<br>
                                            <strong>Caracter√≠stica:</strong> Produto em crescimento no mercado
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-warning">MAXIM</h6>
                                        <p class="card-text small mb-1">
                                            <strong>Padr√£o:</strong> Decrescente<br>
                                            <strong>Volatilidade:</strong> Alta (35%)<br>
                                            <strong>Caracter√≠stica:</strong> Produto maduro com decl√≠nio sazonal
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <small><i class="bi bi-info-circle me-1"></i><strong>Estrat√©gia:</strong> Cada produto requer abordagem diferente de previs√£o e planejamento. Colmeia √© mais previs√≠vel, Piquet oferece oportunidades de crescimento, e Maxim requer gest√£o cuidadosa do decl√≠nio.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais
        let currentPeriod = 13;
        let gameData = {
            config: {},
            demanda: {},
            producao: {},
            compras: {},
            capacidade: {},
            financeiro: {},
            resultados: {}
        };

        // Constantes do jogo (padr√µes)
        const PRODUCTS = ['colmeia', 'piquet', 'maxim'];
        const MATERIALS = ['fio1', 'fio2', 'corantes'];
        const BOM = {
            colmeia: { fio1: 1.0, fio2: 0.0, corantes: 0.10 },
            piquet:  { fio1: 0.0, fio2: 1.0, corantes: 0.12 },
            maxim:   { fio1: 0.5, fio2: 0.5, corantes: 0.15 }
        };
        const MATERIAL_COST = { fio1: 2, fio2: 3, corantes: 1 };
        const PROCESS_RATES = { // unidades por m√°quina por turno no per√≠odo
            tecelagem: 500,
            purgaTinturaria: 800,
            fixacaoAcabamento: 600
        };
        const PROCESS_WEIGHTS = { // carga relativa por produto
            colmeia: { tecelagem: 1.0, purgaTinturaria: 0.8, fixacaoAcabamento: 0.6 },
            piquet:  { tecelagem: 1.0, purgaTinturaria: 1.0, fixacaoAcabamento: 0.7 },
            maxim:   { tecelagem: 1.0, purgaTinturaria: 1.2, fixacaoAcabamento: 0.9 }
        };
        const DEFAULT_PRICES = { colmeia: 20, piquet: 28, maxim: 35 };
    const DEFAULT_COSTS = { custoEstoque: 0.5, penalidadePerda: 5, custosFixos: 2000, custoTerceirizacao: 3 };
    
    // Padr√µes de demanda espec√≠ficos por produto (baseado no LSSP original)
    const DEMAND_PATTERNS = {
        colmeia: {
            trend: 'linear',      // Demanda est√°vel, linear
            volatility: 0.15,     // Baixa volatilidade (15%)
            seasonality: 0.05,    // Pouca sazonalidade (5%)
            description: 'Produto est√°vel com demanda linear'
        },
        piquet: {
            trend: 'growing',     // Demanda crescente
            volatility: 0.25,     // M√©dia volatilidade (25%)
            seasonality: 0.10,    // Sazonalidade moderada (10%)
            description: 'Produto em crescimento no mercado'
        },
        maxim: {
            trend: 'declining',   // Demanda decrescente
            volatility: 0.35,     // Alta volatilidade (35%)
            seasonality: 0.15,    // Alta sazonalidade (15%)
            description: 'Produto maduro com decl√≠nio sazonal'
        }
    };

    // Estado de visualiza√ß√£o (seletores de per√≠odo)
    let financeViewPeriod = null; // per√≠odo selecionado na aba Financeiro
    let reportViewPeriod = null;  // per√≠odo selecionado na aba Relat√≥rios

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
            setupEventListeners();
            initializeGame();
        });

        // Configura√ß√£o dos event listeners
        function setupEventListeners() {
            // Navega√ß√£o (prevenir comportamento padr√£o do link)
            document.getElementById('nav-inicio').addEventListener('click', (e) => { e.preventDefault(); showSection('inicio'); });
            document.getElementById('nav-demanda').addEventListener('click', (e) => { e.preventDefault(); showSection('demanda'); });
            document.getElementById('nav-producao').addEventListener('click', (e) => { e.preventDefault(); showSection('producao'); });
            document.getElementById('nav-compras').addEventListener('click', (e) => { e.preventDefault(); showSection('compras'); });
            document.getElementById('nav-capacidade').addEventListener('click', (e) => { e.preventDefault(); showSection('capacidade'); });
            document.getElementById('nav-financeiro').addEventListener('click', (e) => { e.preventDefault(); showSection('financeiro'); });
            document.getElementById('nav-relatorios').addEventListener('click', (e) => { e.preventDefault(); showSection('relatorios'); });
            
            // A√ß√µes
            document.getElementById('btn-iniciar-jogo').addEventListener('click', iniciarJogo);
            document.getElementById('btn-save').addEventListener('click', saveGameData);
            document.getElementById('btn-reset').addEventListener('click', resetGameData);
            const profSwitch = document.getElementById('modo-professor');
            if (profSwitch) {
                profSwitch.addEventListener('change', (e) => {
                    const pnl = document.getElementById('painel-cenario');
                    if (!pnl) return;
                    const bsCollapse = new bootstrap.Collapse(pnl, { toggle: false });
                    e.target.checked ? bsCollapse.show() : bsCollapse.hide();
                });
            }
            const btnClose = document.getElementById('btn-close-period');
            if (btnClose) btnClose.addEventListener('click', closePeriod);
            updateGlobalActionsUI();
        }

        // Inicializar o jogo
        function initializeGame() {
            if (gameData.config.empresa) {
                // J√° existe um jogo em andamento
                showSection('demanda');
                updateAllDisplays();
            } else {
                // Novo jogo - mostrar tela de cadastro
                showSection('inicio');
            }
            updateGlobalActionsUI();
        }

        // Mostrar se√ß√£o espec√≠fica
        function showSection(section) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.add('d-none');
            });
            
            // Mostrar a se√ß√£o solicitada
            document.getElementById(`tela-${section}`).classList.remove('d-none');
            
            // Atualizar navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`nav-${section}`).classList.add('active');
            
            // Se for a se√ß√£o de relat√≥rios, gerar os relat√≥rios
            if (section === 'relatorios') {
                generateReports();
            }
            // Render din√¢mico da se√ß√£o ativa
            if (section === 'demanda') updateDemandaDisplay();
            if (section === 'producao') updateProducaoDisplay();
            if (section === 'compras') updateComprasDisplay();
            if (section === 'capacidade') updateCapacidadeDisplay();
            if (section === 'financeiro') updateFinanceiroDisplay();
        }

        // Iniciar novo jogo
        function iniciarJogo() {
            const empresa = document.getElementById('empresa').value;
            const integrantes = [
                document.getElementById('integrante1').value,
                document.getElementById('integrante2').value,
                document.getElementById('integrante3').value,
                document.getElementById('integrante4').value,
                document.getElementById('integrante5').value
            ].filter(name => name.trim() !== '');
            
            const tipoDemanda = document.getElementById('tipo-demanda').value;
            const tamanhoEmpresa = document.getElementById('tamanho-empresa').value;
            
            if (!empresa || integrantes.length === 0) {
                alert('Por favor, preencha o nome da empresa e pelo menos um integrante!');
                return;
            }
            
            try {
                // Configurar dados iniciais do jogo
                const cenario = collectScenarioConfig(tipoDemanda);
                
                gameData.config = {
                    empresa,
                    integrantes,
                    tipoDemanda,
                    tamanhoEmpresa,
                    periodoAtual: 13,
                    dataInicio: new Date().toISOString(),
                    cenario
                };

                // Inicializar estruturas de dados vazias
                initializeGameData();

                // Salvar e mostrar a tela de demanda
                saveGameData();
                showSection('demanda');
                updateAllDisplays();
                showToast('Jogo iniciado! Navegando para Demanda.', 'success');
                console.log('Jogo iniciado:', gameData.config);
            } catch (err) {
                console.error('Erro ao iniciar o jogo:', err);
                showToast(`Erro ao iniciar o jogo: ${err.message}`, 'danger');
            }
        }

        // Inicializar estruturas de dados do jogo
        function initializeGameData() {
            // Inicializar dados de demanda
            const numCores = gameData.config.tipoDemanda === 'alta' ? 1 : 
                            gameData.config.tipoDemanda === 'media' ? 3 : 10;
            
            // Dados iniciais baseados no tamanho da empresa
            const estoqueInicial = {
                pequena: { malhas: 100, fios: 100, corantes: 10 },
                media: { malhas: 1000, fios: 1000, corantes: 100 },
                grande: { malhas: 10000, fios: 10000, corantes: 1000 }
            };
            
            const recursosIniciais = {
                pequena: { teares: 2, jets: 5, ramas: 0, turnosTeares: 1, turnosJets: 1, turnosRamas: 0 },
                media: { teares: 5, jets: 3, ramas: 1, turnosTeares: 2, turnosJets: 2, turnosRamas: 1 },
                grande: { teares: 23, jets: 3, ramas: 2, turnosTeares: 3, turnosJets: 3, turnosRamas: 2 }
            };
            
            // Corrige nome da vari√°vel (estoqueInicial) para evitar ReferenceError
            const estoque = estoqueInicial[gameData.config.tamanhoEmpresa];
            const recursos = recursosIniciais[gameData.config.tamanhoEmpresa];
            
            // Inicializar per√≠odos (13 a 24)
            for (let i = 13; i <= 24; i++) {
                // Demanda
                gameData.demanda[i] = {
                    colmeia: { prevista: 0, real: 0 },
                    piquet: { prevista: 0, real: 0 },
                    maxim: { prevista: 0, real: 0 }
                };
                
                // Produ√ß√£o
                gameData.producao[i] = {
                    colmeia: { planejada: 0, real: 0, estoqueInicial: i === 13 ? estoque.malhas : 0, vendas: 0, vendasPerdidas: 0, estoqueFinal: 0 },
                    piquet: { planejada: 0, real: 0, estoqueInicial: i === 13 ? estoque.malhas : 0, vendas: 0, vendasPerdidas: 0, estoqueFinal: 0 },
                    maxim: { planejada: 0, real: 0, estoqueInicial: i === 13 ? estoque.malhas : 0, vendas: 0, vendasPerdidas: 0, estoqueFinal: 0 }
                };
                
                // Compras
                gameData.compras[i] = {
                    fio1: { planejada: 0, real: 0, consumoPrevisto: 0, consumoReal: 0, estoqueInicial: i === 13 ? estoque.fios : 0, estoqueFinal: 0, comprasEmergencia: 0 },
                    fio2: { planejada: 0, real: 0, consumoPrevisto: 0, consumoReal: 0, estoqueInicial: i === 13 ? estoque.fios : 0, estoqueFinal: 0, comprasEmergencia: 0 },
                    corantes: { planejada: 0, real: 0, consumoPrevisto: 0, consumoReal: 0, estoqueInicial: i === 13 ? estoque.corantes : 0, estoqueFinal: 0, comprasEmergencia: 0 }
                };
                
                // Capacidade
                gameData.capacidade[i] = {
                    tecelagem: {
                        necessaria: 0,
                        disponivel: 0,
                        instalada: 0,
                        terceirizada: 0,
                        turnos: recursos.turnosTeares,
                        teares: recursos.teares,
                        validacao: 'N√ÉO'
                    },
                    purgaTinturaria: {
                        necessaria: 0,
                        disponivel: 0,
                        instalada: 0,
                        terceirizada: 0,
                        turnos: recursos.turnosJets,
                        jets: recursos.jets,
                        validacao: 'N√ÉO'
                    },
                    fixacaoAcabamento: {
                        necessaria: 0,
                        disponivel: 0,
                        instalada: 0,
                        terceirizada: 0,
                        turnos: recursos.turnosRamas,
                        ramas: recursos.ramas,
                        validacao: 'N√ÉO'
                    }
                };
                
                // Financeiro
                gameData.financeiro[i] = {
                    custosFixos: 0,
                    custosCompras: 0,
                    custosEstoques: 0,
                    custosTerceirizacao: 0,
                    custosCapital: 0,
                    custosVendasPerdidas: 0,
                    receitaVendas: 0,
                    resultadoOperacional: 0,
                    resultadoAcumulado: 0
                };
            }
            
            // Resultados iniciais
            gameData.resultados = {
                previsaoErro: { colmeia: 0, piquet: 0, maxim: 0 },
                utilizacaoCapacidade: { tecelagem: 0, purgaTinturaria: 0, fixacaoAcabamento: 0 },
                indicadores: { nivelServico: 0, giroEstoques: 0, lucratividade: 0 }
            };
        }

        // Atualizar todas as visualiza√ß√µes
        function updateAllDisplays() {
            updateDemandaDisplay();
            updateProducaoDisplay();
            updateComprasDisplay();
            updateCapacidadeDisplay();
            updateFinanceiroDisplay();
            updateGlobalActionsUI();
        }

        // Atualiza bot√µes globais conforme status
        function updateGlobalActionsUI() {
            const btn = document.getElementById('btn-close-period');
            if (!btn) return;
            const ultimo = Number(gameData.config?.ultimoFechado || 0);
            const concluida = !!gameData.config?.simulacaoConcluida || ultimo >= 24;
            btn.disabled = concluida;
            btn.title = concluida ? 'Simula√ß√£o conclu√≠da' : 'Fechar Per√≠odo';
        }

        // Salvar dados do jogo
        function saveGameData() {
            try {
                localStorage.setItem('produSIM_pcp1', JSON.stringify(gameData));
                showToast('Jogo salvo com sucesso!', 'success');
            } catch (e) {
                console.warn('Falha ao salvar no localStorage:', e);
                alert('Aviso: n√£o foi poss√≠vel salvar os dados localmente.');
            }
        }

        // Carregar dados do jogo
        function loadGameData() {
            const savedData = localStorage.getItem('produSIM_pcp1');
            if (savedData) {
                try {
                    gameData = JSON.parse(savedData);
                } catch (e) {
                    console.warn('Dados corrompidos no localStorage. Limpando...', e);
                    localStorage.removeItem('produSIM_pcp1');
                    gameData = {
                        config: {},
                        demanda: {},
                        producao: {},
                        compras: {},
                        capacidade: {},
                        financeiro: {},
                        resultados: {}
                    };
                }
            }
        }

        // Resetar dados do jogo (com recarregamento autom√°tico)
        function resetGameData() {
            if (!confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            try { localStorage.removeItem('produSIM_pcp1'); } catch(e){ console.warn(e); }
            // Zera estado em mem√≥ria
            gameData = { config: {}, demanda: {}, producao: {}, compras: {}, capacidade: {}, financeiro: {}, resultados: {} };
            currentPeriod = 13; financeViewPeriod = null; reportViewPeriod = null;
            // Limpa campos do formul√°rio inicial
            const ids = ['empresa','integrante1','integrante2','integrante3','integrante4','integrante5'];
            ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
            const setVal=(id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
            setVal('tipo-demanda','media'); setVal('tamanho-empresa','media');
            // Painel de cen√°rio: desmarca e recolhe; restaura defaults
            const prof = document.getElementById('modo-professor'); if (prof){ prof.checked=false; }
            const pnl = document.getElementById('painel-cenario'); if (pnl){ try{ new bootstrap.Collapse(pnl, {toggle:false}).hide(); }catch{} }
            setVal('cen-vol','20'); setVal('cen-cust-estoque','2'); setVal('cen-penalidade','5'); setVal('cen-custos-fixos','5000');
            setVal('preco-colmeia','20'); setVal('preco-piquet','28'); setVal('preco-maxim','35');
            // Volta para in√≠cio e atualiza UI
            showSection('inicio'); updateGlobalActionsUI();
            // Feedback e recarrega com cache-busting para evitar necessidade de Ctrl+F5
            const reloadNow = ()=>{ try{ window.location.replace(window.location.pathname + window.location.search.split('?')[0] + '?reset=' + Date.now()); } catch { window.location.reload(); } };
            showToast('Dados resetados. Recarregando...', 'info');
            setTimeout(reloadNow, 150);
        }

        // Mostrar notifica√ß√£o
        function showToast(message, type = 'info') {
            try {
                if (window.bootstrap && typeof window.bootstrap.Toast === 'function') {
                    const toastContainer = document.getElementById('toast-container') || createToastContainer();
                    const toast = document.createElement('div');
                    toast.className = `toast align-items-center text-bg-${type} border-0`;
                    toast.setAttribute('role', 'alert');
                    toast.setAttribute('aria-live', 'assertive');
                    toast.setAttribute('aria-atomic', 'true');
                    toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    `;
                    toastContainer.appendChild(toast);
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.show();
                    toast.addEventListener('hidden.bs.toast', () => toast.remove());
                } else {
                    alert(message);
                }
            } catch (e) {
                console.warn('Falha ao exibir toast, usando alert:', e);
                alert(message);
            }
        }

        // Criar container para toasts
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1100';
            document.body.appendChild(container);
            return container;
        }

        // Relat√≥rio final em PDF (consolidado)
        function generateFinalPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margin = 15; let y = margin;
            const pEnd = 24;
            const totals = computeFinalTotals(pEnd);

            doc.setFontSize(18);
            doc.text('Relat√≥rio Final ‚Äì ProduSIM PCP1', 105, y, { align: 'center' }); y += 8;
            doc.setFontSize(11);
            doc.text(`Empresa: ${gameData.config.empresa}`, margin, y); y += 6;
            doc.text(`Integrantes: ${gameData.config.integrantes?.join(', ')||''}`, margin, y); y += 6;
            doc.text(`Tipo de Demanda: ${gameData.config.tipoDemanda} | Tamanho: ${gameData.config.tamanhoEmpresa}`, margin, y); y += 8;

            doc.setFontSize(12);
            doc.text('Resumo da Simula√ß√£o (Per√≠odos 13‚Äì24)', margin, y); y += 6;
            doc.setFontSize(11);
            doc.text(`Receita total: R$ ${totals.receita.toFixed(2)}`, margin, y); y += 6;
            doc.text(`Custos totais: R$ ${totals.custos.toFixed(2)}`, margin, y); y += 6;
            doc.text(`Resultado acumulado: R$ ${totals.resultadoAcumulado.toFixed(2)}`, margin, y); y += 8;

            const addHeader = () => { doc.setFontSize(11); doc.text('Per√≠odo  Receita   Custos   Resultado   Acumulado', margin, y); y += 5; };
            addHeader();
            for (let p=13; p<=pEnd; p++) {
                const f = gameData.financeiro[p] || {};
                const custos = (Number(f.custosCompras||0)+Number(f.custosFixos||0)+Number(f.custosEstoques||0)+Number(f.custosVendasPerdidas||0)+Number(f.custosTerceirizacao||0));
                const linha = `${p.toString().padEnd(7)} R$ ${Number(f.receitaVendas||0).toFixed(2).padStart(8)}  R$ ${custos.toFixed(2).padStart(8)}  R$ ${Number(f.resultadoOperacional||0).toFixed(2).padStart(9)}  R$ ${Number(f.resultadoAcumulado||0).toFixed(2).padStart(9)}`;
                if (y > 280) { doc.addPage(); y = margin; addHeader(); }
                doc.text(linha, margin, y); y += 5;
            }

            if (y > 260) { doc.addPage(); y = margin; }
            doc.setFontSize(12); doc.text('Indicadores', margin, y); y += 6; doc.setFontSize(11);
            const ns = (computeServiceLevelTill(pEnd)*100).toFixed(1);
            doc.text(`N√≠vel de servi√ßo: ${ns}%`, margin, y); y += 6;
            
            // Calcular erro m√©dio de previs√£o
            let totalErros = 0, countErros = 0;
            for (let p=13; p<=pEnd; p++) {
                PRODUCTS.forEach(k => {
                    const erro = gameData.demanda[p]?.[k]?.erroPrevisao;
                    if (erro !== undefined) { totalErros += erro; countErros++; }
                });
            }
            const erroMedio = countErros > 0 ? (totalErros/countErros*100).toFixed(1) : 'N/A';
            doc.text(`Erro m√©dio de previs√£o: ${erroMedio}%`, margin, y); y += 6;
            
            // Adicionar informa√ß√µes sobre gest√£o de capacidade
            if (y > 250) { doc.addPage(); y = margin; }
            doc.setFontSize(12); doc.text('Gest√£o de Capacidade', margin, y); y += 6; doc.setFontSize(11);
            
            // Calcular estat√≠sticas de turnos e custos
            let totalTurnosExtras = 0, custoTotalTurnos = 0;
            const processos = ['tecelagem', 'purgaTinturaria', 'fixacaoAcabamento'];
            for (let p=13; p<=pEnd; p++) {
                if (gameData.capacidade[p]) {
                    processos.forEach(proc => {
                        const turnos = gameData.capacidade[p][proc]?.turnos || 0;
                        const turnosExtras = Math.max(0, turnos - 1);
                        totalTurnosExtras += turnosExtras;
                        custoTotalTurnos += turnosExtras * 500;
                    });
                }
            }
            
            doc.text(`Total de turnos extras utilizados: ${totalTurnosExtras}`, margin, y); y += 6;
            doc.text(`Custo total de turnos extras: R$ ${custoTotalTurnos.toFixed(2)}`, margin, y); y += 6;
            doc.text(`M√©dia de turnos extras por per√≠odo: ${(totalTurnosExtras/12).toFixed(1)}`, margin, y); y += 8;
            
            doc.text(`Data de in√≠cio: ${gameData.config.dataInicio?.split('T')[0]||''}`, margin, y); y += 6;
            doc.text('Desenvolvido por: LABINFO/FAEN/UFGD - 2025', margin, y); y += 6;
            doc.setFontSize(9);
            doc.text('ProduSIM v1.3.0 - Inclui gest√£o din√¢mica de capacidade e calculadora BOM inteligente', margin, y); y += 6;

            doc.save(`Relatorio_Final_ProduSIM_${(gameData.config.empresa||'Empresa').replace(/\s+/g,'_')}.pdf`);
            showToast('Relat√≥rio final exportado!', 'success');
        }

        // Helpers de cen√°rio
    function collectScenarioConfig(tipoDemandaSel) {
            const vol = parseFloat(document.getElementById('cen-vol')?.value || 20);
            const custoEstoque = parseFloat(document.getElementById('cen-cust-estoque')?.value || DEFAULT_COSTS.custoEstoque);
            const penal = parseFloat(document.getElementById('cen-penalidade')?.value || DEFAULT_COSTS.penalidadePerda);
            const fixos = parseFloat(document.getElementById('cen-custos-fixos')?.value || DEFAULT_COSTS.custosFixos);
            const precos = {
                colmeia: parseFloat(document.getElementById('preco-colmeia')?.value || DEFAULT_PRICES.colmeia),
                piquet: parseFloat(document.getElementById('preco-piquet')?.value || DEFAULT_PRICES.piquet),
                maxim: parseFloat(document.getElementById('preco-maxim')?.value || DEFAULT_PRICES.maxim)
            };
            
            // Verificar se est√° no modo avan√ßado
            const modoAvancado = document.getElementById('modo-professor')?.checked || false;
            
            // Configurar padr√µes de demanda
            let patterns = {};
            let volatilities = {};
            
            if (modoAvancado) {
                // Modo avan√ßado: usar configura√ß√µes espec√≠ficas
                patterns = {
                    colmeia: document.getElementById('pattern-colmeia')?.value || 'linear',
                    piquet: document.getElementById('pattern-piquet')?.value || 'growing', 
                    maxim: document.getElementById('pattern-maxim')?.value || 'declining'
                };
                // No modo avan√ßado, os valores s√£o multiplicadores diretos da volatilidade base
                volatilities = {
                    colmeia: parseFloat(document.getElementById('vol-colmeia')?.value || 0.75),
                    piquet: parseFloat(document.getElementById('vol-piquet')?.value || 1.25),
                    maxim: parseFloat(document.getElementById('vol-maxim')?.value || 1.75)
                };
            } else {
                // Modo padr√£o: usar padr√µes do LSSP original
                patterns = {
                    colmeia: DEMAND_PATTERNS.colmeia.trend,
                    piquet: DEMAND_PATTERNS.piquet.trend,
                    maxim: DEMAND_PATTERNS.maxim.trend
                };
                // No modo padr√£o, calcular como multiplicadores da volatilidade base (20%)
                volatilities = {
                    colmeia: DEMAND_PATTERNS.colmeia.volatility / 0.20, // 15%/20% = 0.75
                    piquet: DEMAND_PATTERNS.piquet.volatility / 0.20,   // 25%/20% = 1.25
                    maxim: DEMAND_PATTERNS.maxim.volatility / 0.20      // 35%/20% = 1.75
                };
            }
            
            // Gerar demanda base com padr√µes espec√≠ficos por produto
            const base = generateDemandBase(tipoDemandaSel, patterns);
            
            return {
                volatilidade: vol / 100, // Volatilidade base (20%)
                volatilidades: volatilities, // Multiplicadores por produto
                patterns: patterns, // Padr√µes de tend√™ncia por produto
                custoEstoque,
                penalidadePerda: penal,
                custosFixos: fixos,
                precos,
                custoTerceirizacao: DEFAULT_COSTS.custoTerceirizacao,
                demandaBase: base
            };
        }
        
        // Nova fun√ß√£o para gerar demanda base com padr√µes espec√≠ficos
        function generateDemandBase(tipoDemanda, patterns) {
            const base = {};
            
            // Demandas base iniciais por tipo
            const baseLevels = {
                alta: { colmeia: 1200, piquet: 900, maxim: 700 },
                media: { colmeia: 600, piquet: 450, maxim: 350 },
                baixa: { colmeia: 200, piquet: 150, maxim: 100 }
            };
            
            const baseLevel = baseLevels[tipoDemanda] || baseLevels.media;
            
            for (let p = 13; p <= 24; p++) {
                base[p] = {};
                const progress = (p - 13) / 11; // 0 a 1 ao longo dos 12 per√≠odos
                
                PRODUCTS.forEach(product => {
                    const baseValue = baseLevel[product];
                    const pattern = patterns[product];
                    const seasonality = DEMAND_PATTERNS[product].seasonality;
                    
                    let adjustedValue = baseValue;
                    
                    // Aplicar tend√™ncia baseada no padr√£o
                    switch (pattern) {
                        case 'growing':
                            // Crescimento de 0% a 40% ao longo dos per√≠odos
                            adjustedValue *= (1 + progress * 0.4);
                            break;
                        case 'declining':
                            // Decl√≠nio de 0% a -30% ao longo dos per√≠odos
                            adjustedValue *= (1 - progress * 0.3);
                            break;
                        case 'linear':
                        default:
                            // Mant√©m est√°vel com pequena varia√ß√£o
                            adjustedValue *= (1 + (Math.sin(progress * Math.PI * 2) * 0.05));
                            break;
                    }
                    
                    // Aplicar componente sazonal
                    const seasonalFactor = Math.sin(progress * Math.PI * 4) * seasonality;
                    adjustedValue *= (1 + seasonalFactor);
                    
                    base[p][product] = Math.max(50, Math.round(adjustedValue));
                });
            }
            
            return base;
        }

        function getPeriodoAtual() { return gameData.config?.periodoAtual || 13; }

        // Render: Demanda
        let demandaChart;
        function updateDemandaDisplay() {
            const p = getPeriodoAtual();
            const el = document.getElementById('tela-demanda');
            if (!el) return;
            const d = gameData.demanda[p];
            const cenario = gameData.config.cenario;
            el.innerHTML = `
                <div class="simulation-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-graph-up text-primary me-2"></i>Demanda ‚Äì Per√≠odo ${p}</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="btn-prev-period"><i class="bi bi-arrow-left"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" id="btn-next-period"><i class="bi bi-arrow-right"></i></button>
                        </div>
                    </div>
                    <div class="row g-3">
                        ${PRODUCTS.map(prod => {
                            const periodoFechado = (gameData.config?.ultimoFechado || 0) >= p;
                            const erroPrevisao = gameData.demanda[p]?.[prod]?.erroPrevisao;
                            const erroInfo = periodoFechado && erroPrevisao !== undefined ? 
                                `<div class="alert alert-info mt-2 py-1">
                                    <small><strong>Erro de Previs√£o:</strong> ${(erroPrevisao*100).toFixed(1)}%</small>
                                </div>` : '';
                            return `
                        <div class="col-md-4">
                            <div class="decision-panel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="text-capitalize">${prod}</strong>
                                    <span class="badge bg-light text-dark">Base: ${cenario.demandaBase[p][prod]}</span>
                                </div>
                                <label class="form-label">Previs√£o de Demanda</label>
                                <input type="number" class="form-control" id="prev-${prod}" value="${d[prod].prevista}" min="0" ${periodoFechado ? 'disabled' : ''}>
                                <div class="small text-muted mt-2">Real √∫ltima: ${gameData.demanda[p-1]?.[prod]?.real || 0}</div>
                                ${periodoFechado ? `<div class="small text-success mt-1">Real atual: ${gameData.demanda[p][prod].real || 0}</div>` : ''}
                                ${erroInfo}
                            </div>
                        </div>`;
                        }).join('')}
                    </div>
                    <div class="mt-3">
                        <canvas id="chart-demanda" height="100"></canvas>
                    </div>
                </div>`;

            // Bind prev/next
            document.getElementById('btn-prev-period').onclick = () => { changePeriod(-1); };
            document.getElementById('btn-next-period').onclick = () => { changePeriod(1); };
            // Save on input change
            const periodoFechado = (gameData.config?.ultimoFechado || 0) >= p;
            PRODUCTS.forEach(prod => {
                const inp = document.getElementById(`prev-${prod}`);
                if (inp && !periodoFechado) inp.addEventListener('change', (e) => {
                    gameData.demanda[p][prod].prevista = Number(e.target.value) || 0;
                    saveGameData();
                    renderDemandaChart();
                });
            });
            renderDemandaChart();
        }

        function renderDemandaChart() {
            const ctx = document.getElementById('chart-demanda');
            if (!ctx) return;
            const p = getPeriodoAtual();
            const labels = [];
            for (let i = 13; i <= p; i++) labels.push(String(i));
            const datasets = PRODUCTS.map((prod, idx) => ({
                label: `Real ${prod}`,
                data: labels.map((_, k) => gameData.demanda[13+k]?.[prod]?.real || 0),
                borderColor: ['#0d6efd','#198754','#dc3545'][idx],
                backgroundColor: 'transparent',
                tension: 0.2
            })).concat(PRODUCTS.map((prod, idx) => ({
                label: `Prevista ${prod}`,
                data: labels.map((_, k) => gameData.demanda[13+k]?.[prod]?.prevista || 0),
                borderColor: ['#0d6efd66','#19875466','#dc354566'][idx],
                borderDash: [5,5],
                backgroundColor: 'transparent',
                tension: 0.2
            })));
            if (demandaChart) demandaChart.destroy();
            demandaChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
        }

        // Render: Produ√ß√£o
        function updateProducaoDisplay() {
            const p = getPeriodoAtual();
            const el = document.getElementById('tela-producao');
            if (!el) return;
            const prod = gameData.producao[p];
            el.innerHTML = `
                <div class="simulation-container">
                    <h5 class="mb-3"><i class="bi bi-gear text-primary me-2"></i>Produ√ß√£o ‚Äì Per√≠odo ${p}</h5>
                    <div class="row g-3">
                        ${PRODUCTS.map(k=>`
                        <div class="col-md-4">
                            <div class="decision-panel">
                                <div class="d-flex justify-content-between">
                                    <strong class="text-capitalize">${k}</strong>
                                    <span class="small text-muted">Est. Inicial: ${prod[k].estoqueInicial}</span>
                                </div>
                                <label class="form-label mt-2">Produ√ß√£o Planejada</label>
                                <input type="number" class="form-control" id="plan-${k}" value="${prod[k].planejada}" min="0">
                                <div class="small text-muted mt-2">Est. Final (estimado): ${(prod[k].estoqueInicial + prod[k].planejada) - (gameData.demanda[p][k].prevista || 0)}</div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            PRODUCTS.forEach(k=>{
                const elIn = document.getElementById(`plan-${k}`);
                if (elIn) elIn.addEventListener('change', (e)=>{
                    gameData.producao[p][k].planejada = Number(e.target.value)||0;
                    saveGameData();
                });
            });
        }

        // Render: Compras
        function updateComprasDisplay() {
            const p = getPeriodoAtual();
            const el = document.getElementById('tela-compras');
            if (!el) return;
            const comp = gameData.compras[p];
            const periodoFechado = (gameData.config?.ultimoFechado || 0) >= p;
            
            // Calcular necessidades BOM baseadas na produ√ß√£o planejada
            let necessidadesBOM = { fio1: 0, fio2: 0, corantes: 0 };
            PRODUCTS.forEach(k => {
                const qtdProduzir = gameData.producao[p][k].planejada || 0;
                MATERIALS.forEach(m => {
                    necessidadesBOM[m] += qtdProduzir * (BOM[k][m] || 0);
                });
            });
            
            el.innerHTML = `
                <div class="simulation-container">
                    <h5 class="mb-3"><i class="bi bi-cart text-primary me-2"></i>Compras ‚Äì Per√≠odo ${p}</h5>
                    
                    <div class="alert alert-info mb-3">
                        <strong><i class="bi bi-calculator me-2"></i>Calculadora BOM (baseada na produ√ß√£o planejada):</strong><br>
                        ${MATERIALS.map(m => {
                            const necessidade = Math.round(necessidadesBOM[m] * 10) / 10; // Arredondar para 1 casa decimal
                            const estoque = comp[m].estoqueInicial || 0;
                            const sugestao = Math.max(0, Math.ceil(necessidade - estoque));
                            return `<span class="badge bg-light text-dark me-2 mb-1">${m.toUpperCase()}: ${necessidade} unid. necess√°rias</span>`;
                        }).join('')}
                    </div>
                    
                    <div class="row g-3">
                        ${MATERIALS.map(m=>{
                            const comprasEmerg = comp[m].comprasEmergencia || 0;
                            const emergencyInfo = periodoFechado && comprasEmerg > 0 ? 
                                `<div class="alert alert-warning mt-2 py-2">
                                    <small><strong>Compras de Emerg√™ncia:</strong> ${comprasEmerg} unidades<br>
                                    <em>Custo premium aplicado (+50%)</em></small>
                                </div>` : '';
                            return `
                        <div class="col-md-4">
                            <div class="decision-panel">
                                <div class="d-flex justify-content-between">
                                    <strong class="text-uppercase">${m}</strong>
                                    <span class="small text-muted">Est. Inicial: ${comp[m].estoqueInicial}</span>
                                </div>
                                <label class="form-label mt-2">Compra Planejada</label>
                                <input type="number" class="form-control" id="buy-${m}" value="${comp[m].planejada}" min="0" ${periodoFechado ? 'disabled' : ''}>
                                ${emergencyInfo}
                                ${periodoFechado ? `<div class="small text-muted mt-2">Est. Final: ${comp[m].estoqueFinal || 0}</div>` : ''}
                            </div>
                        </div>`;
                        }).join('')}
                    </div>
                </div>`;
            MATERIALS.forEach(m=>{
                const elIn = document.getElementById(`buy-${m}`);
                if (elIn && !periodoFechado) elIn.addEventListener('change',(e)=>{
                    gameData.compras[p][m].planejada = Number(e.target.value)||0;
                    saveGameData();
                });
            });
        }

        // Fun√ß√£o para aplicar sugest√µes BOM automaticamente
        function aplicarSugestaoBOM() {
            const p = getPeriodoAtual();
            const comp = gameData.compras[p];
            
            // Calcular necessidades BOM
            let necessidadesBOM = { fio1: 0, fio2: 0, corantes: 0 };
            PRODUCTS.forEach(k => {
                const qtdProduzir = gameData.producao[p][k].planejada || 0;
                MATERIALS.forEach(m => {
                    necessidadesBOM[m] += qtdProduzir * (BOM[k][m] || 0);
                });
            });
            
            // Aplicar sugest√µes
            MATERIALS.forEach(m => {
                const necessidade = necessidadesBOM[m];
                const estoque = comp[m].estoqueInicial || 0;
                const sugestao = Math.max(0, Math.ceil(necessidade - estoque));
                
                comp[m].planejada = sugestao;
                const input = document.getElementById(`buy-${m}`);
                if (input) input.value = sugestao;
            });
            
            saveGameData();
            showToast('Sugest√µes BOM aplicadas com sucesso!', 'success');
        }

        // Render: Capacidade
        function updateCapacidadeDisplay() {
            const p = getPeriodoAtual();
            const el = document.getElementById('tela-capacidade');
            if (!el) return;
            const cap = computeCapacity(p);
            const capData = gameData.capacidade[p];
            const periodoFechado = (gameData.config?.ultimoFechado || 0) >= p;
            
            el.innerHTML = `
                <div class="simulation-container">
                    <h5 class="mb-3"><i class="bi bi-building text-primary me-2"></i>Capacidade ‚Äì Per√≠odo ${p}</h5>
                    
                    <div class="alert alert-info mb-3">
                        <strong><i class="bi bi-info-circle me-2"></i>Ajuste de Turnos por Processo:</strong><br>
                        <small>Voc√™ pode ajustar o n√∫mero de turnos para cada processo. Mais turnos = maior capacidade, mas tamb√©m maiores custos fixos.</small>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        ${['tecelagem','purgaTinturaria','fixacaoAcabamento'].map(proc=>{
                            const maquinas = proc === 'tecelagem' ? 'teares' : (proc === 'purgaTinturaria' ? 'jets' : 'ramas');
                            const numMaquinas = capData[proc][maquinas] || 0;
                            const turnosAtual = capData[proc].turnos || 0;
                            const maxTurnos = 3; // M√°ximo 3 turnos por processo
                            const semEquipamento = numMaquinas === 0;
                            
                            return `
                            <div class="col-md-4">
                                <div class="decision-panel ${semEquipamento ? 'border-warning' : ''}">
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>${proc.charAt(0).toUpperCase() + proc.slice(1)}</strong>
                                        <span class="small text-muted">${numMaquinas} ${maquinas}</span>
                                    </div>
                                    
                                    ${semEquipamento ? `
                                        <div class="alert alert-warning alert-sm p-2 mb-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <strong>Sem equipamento!</strong><br>
                                            <small>Esta empresa n√£o possui ${maquinas} para este processo. Todo trabalho ser√° terceirizado.</small>
                                        </div>
                                        <select class="form-control" disabled>
                                            <option>0 turnos (sem equipamento)</option>
                                        </select>
                                    ` : `
                                        <label class="form-label">Turnos de Trabalho</label>
                                        <select class="form-control" id="turnos-${proc}" ${periodoFechado ? 'disabled' : ''}>
                                            ${[...Array(maxTurnos + 1)].map((_, i) => 
                                                `<option value="${i}" ${turnosAtual === i ? 'selected' : ''}>
                                                    ${i === 0 ? '0 turnos (parado)' : `${i} turno${i > 1 ? 's' : ''}`}
                                                </option>`
                                            ).join('')}
                                        </select>
                                    `}
                                    
                                    <div class="mt-2 small">
                                        <div>Capacidade: ${cap[proc].disponivel.toFixed(0)} h/per√≠odo</div>
                                        <div>Necess√°ria: ${cap[proc].necessaria.toFixed(0)} h/per√≠odo</div>
                                        ${cap[proc].necessaria > 0 && cap[proc].disponivel === 0 ? 
                                            '<div class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>100% terceirizado</div>' :
                                            cap[proc].necessaria > cap[proc].disponivel ? 
                                                '<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Terceiriza√ß√£o necess√°ria!</div>' : 
                                                '<div class="text-success"><i class="bi bi-check-circle me-1"></i>Capacidade suficiente</div>'}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <div class="row g-3">
                        ${['tecelagem','purgaTinturaria','fixacaoAcabamento'].map(proc=>{
                            const util = cap[proc].necessaria>0? Math.min(100, Math.round((cap[proc].necessaria/cap[proc].disponivel)*100)) : 0;
                            const semEquipamento = (capData[proc][proc === 'tecelagem' ? 'teares' : (proc === 'purgaTinturaria' ? 'jets' : 'ramas')] || 0) === 0;
                            const terceirizacaoTotal = cap[proc].necessaria > 0 && cap[proc].disponivel === 0;
                            
                            return `
                            <div class="col-md-4">
                                <div class="result-panel ${terceirizacaoTotal ? 'border-warning' : ''}">
                                    <div class="d-flex justify-content-between mb-1"><strong>Utiliza√ß√£o ${proc}</strong><span class="small">${terceirizacaoTotal ? '100% Terc.' : util + '%'}</span></div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar ${terceirizacaoTotal ? 'bg-warning' : util>100? 'bg-danger':'bg-success'}" 
                                             role="progressbar" 
                                             style="width:${terceirizacaoTotal ? 100 : Math.min(util,100)}%">
                                        </div>
                                    </div>
                                    <div class="small">
                                        ${terceirizacaoTotal ? 
                                            `<span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Tudo terceirizado (${cap[proc].necessaria.toFixed(0)}h)</span>` :
                                            util > 100 ? 
                                                `<span class="text-danger">Sobrecarga: ${(cap[proc].necessaria - cap[proc].disponivel).toFixed(0)} h terceirizadas</span>` :
                                                cap[proc].necessaria > 0 ?
                                                    `<span class="text-success">Folga: ${(cap[proc].disponivel - cap[proc].necessaria).toFixed(0)} h dispon√≠veis</span>` :
                                                    `<span class="text-muted">Processo parado</span>`
                                        }
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;

            // Adicionar event listeners para os selects de turnos
            if (!periodoFechado) {
                ['tecelagem','purgaTinturaria','fixacaoAcabamento'].forEach(proc => {
                    const select = document.getElementById(`turnos-${proc}`);
                    // S√≥ adicionar event listener se o select existir e n√£o estiver desabilitado
                    if (select && !select.disabled) {
                        select.addEventListener('change', (e) => {
                            const newTurnos = Number(e.target.value);
                            console.log(`Alterando turnos de ${proc} para ${newTurnos}`);
                            
                            // Atualizar os dados imediatamente
                            gameData.capacidade[p][proc].turnos = newTurnos;
                            
                            // Salvar dados
                            saveGameData();
                            
                            // For√ßar rec√°lculo da capacidade
                            const updatedCap = computeCapacity(p);
                            console.log(`Capacidade recalculada para ${proc}:`, updatedCap[proc]);
                            
                            // Atualizar interface imediatamente
                            updateCapacidadeDisplay();
                            
                            // Mostrar feedback visual
                            showToast(`Capacidade de ${proc} ajustada para ${newTurnos} turno${newTurnos !== 1 ? 's' : ''}`, 'success');
                        });
                    } else if (!select) {
                        console.log(`Processo ${proc} n√£o possui equipamento dispon√≠vel (select n√£o criado)`);
                    }
                });
            }
        }

        // Render: Financeiro
        function updateFinanceiroDisplay() {
            const pAtual = getPeriodoAtual();
            const pEnd = gameData.config.ultimoFechado || pAtual;
            const p = financeViewPeriod || pEnd;
            const el = document.getElementById('tela-financeiro');
            if (!el) return;
            // Recalcula on-demand se houver vendas e fin estiver zerado
            const vendasTot = PRODUCTS.reduce((s,k)=> s + (gameData.producao[p]?.[k]?.vendas || 0), 0);
            if (vendasTot > 0) {
                const finTest = gameData.financeiro[p] || {};
                const sum = (val)=> Number(val||0);
                const totalAbs = sum(finTest.receitaVendas)+sum(finTest.custosCompras)+sum(finTest.custosFixos)+sum(finTest.custosEstoques)+sum(finTest.custosVendasPerdidas)+sum(finTest.custosTerceirizacao);
                if (totalAbs === 0) computeFinance(p);
            }
            const fin = gameData.financeiro[p] || {};
            
            // Calcular custos de compras de emerg√™ncia para o per√≠odo
            let custoComprasEmergencia = 0;
            if (gameData.compras[p]) {
                MATERIALS.forEach(m => {
                    const comprasEmerg = gameData.compras[p][m].comprasEmergencia || 0;
                    custoComprasEmergencia += comprasEmerg * (MATERIAL_COST[m] || 0) * 1.5;
                });
            }
            
            // Calcular custo de turnos extras
            let custoTurnosExtras = 0;
            if (gameData.capacidade[p]) {
                const capData = gameData.capacidade[p];
                const turnosExtras = Math.max(0, (capData.tecelagem.turnos || 0) - 1) +
                                    Math.max(0, (capData.purgaTinturaria.turnos || 0) - 1) +
                                    Math.max(0, (capData.fixacaoAcabamento.turnos || 0) - 1);
                custoTurnosExtras = turnosExtras * 500;
            }
            
            el.innerHTML = `
                <div class="simulation-container">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-3"><i class="bi bi-currency-dollar text-primary me-2"></i>Financeiro ‚Äì Per√≠odo ${p}</h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="me-1 small text-muted">Ver per√≠odo:</label>
                            <select id="sel-fin-periodo" class="form-select form-select-sm" style="width:auto">
                                ${Array.from({length: (pEnd-12)}, (_,i)=> 13+i).map(pi=>`<option value="${pi}" ${pi===p? 'selected':''}>${pi}</option>`).join('')}
                            </select>
                            ${p !== pAtual ? `<span class="badge rounded-pill text-bg-light">Atual: ${pAtual}</span>` : ''}
                        </div>
                    </div>
                    <div class="row g-3">
                        ${[
                            ['Receita de Vendas', fin.receitaVendas],
                            ['Custos de Compras', -((fin.custosCompras || 0) - custoComprasEmergencia)],
                            ['Compras de Emerg√™ncia', -custoComprasEmergencia],
                            ['Custos Fixos Base', -(fin.custosFixos - custoTurnosExtras)],
                            ['Custos Turnos Extras', -custoTurnosExtras],
                            ['Custos de Estoque', -fin.custosEstoques],
                            ['Vendas Perdidas', -fin.custosVendasPerdidas],
                            ['Terceiriza√ß√£o', -fin.custosTerceirizacao],
                            ['Resultado Operacional', fin.resultadoOperacional]
                        ].map(([label,val])=>`
                        <div class="col-md-4">
                            <div class="result-panel">
                                <div class="text-muted small">${label}</div>
                                <div class="fs-5">R$ ${Number(val||0).toFixed(2)}</div>
                            </div>
                        </div>`).join('')}
                    </div>
                    <div class="financial-summary mt-2">
                        <div class="d-flex justify-content-between"><span>Resultado Acumulado</span><strong>R$ ${Number(fin.resultadoAcumulado||0).toFixed(2)}</strong></div>
                    </div>
                </div>`;
            const sel = document.getElementById('sel-fin-periodo');
            if (sel) sel.addEventListener('change', (e)=>{ financeViewPeriod = Number(e.target.value)||pEnd; updateFinanceiroDisplay(); });
        }

        // Relat√≥rios
        function generateReports() {
            const el = document.getElementById('tela-relatorios');
            if (!el) return;
            const pEnd = Number(gameData.config.ultimoFechado || 13);
            const concluida = (!!gameData.config.simulacaoConcluida) || pEnd >= 24;
            const totals = computeFinalTotals(concluida ? 24 : pEnd);
            const pSel = reportViewPeriod || pEnd;
            const finSel = gameData.financeiro[pSel] || {};
            el.innerHTML = `
                <div class="simulation-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data text-primary me-2"></i>${concluida? 'Relat√≥rio Final' : 'Relat√≥rio Parcial'}</h5>
                        <button class="btn btn-outline-primary btn-sm" id="btn-export-pdf" ${concluida? '' : 'disabled'}><i class="bi bi-filetype-pdf me-1"></i>Exportar PDF</button>
                    </div>
                    ${!concluida ? '<div class="alert alert-warning">O relat√≥rio final estar√° dispon√≠vel ao t√©rmino do per√≠odo 24. Abaixo um resumo parcial.</div>' : ''}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="result-panel">
                                <div class="fw-bold mb-2">Resumo Financeiro (${concluida ? 'Total Simula√ß√£o' : 'At√© Per√≠odo '+pEnd})</div>
                                <ul class="mb-0">
                                    <li>Receita total: R$ ${totals.receita.toFixed(2)}</li>
                                    <li>Custos totais: R$ ${totals.custos.toFixed(2)}</li>
                                    <li>Resultado acumulado: R$ ${totals.resultadoAcumulado.toFixed(2)}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="result-panel">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="fw-bold mb-2">Detalhe por Per√≠odo</div>
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="me-1 small text-muted">Ver per√≠odo:</label>
                                        <select id="sel-relatorio-periodo" class="form-select form-select-sm" style="width:auto">
                                            ${Array.from({length: (pEnd-12)}, (_,i)=> 13+i).map(pi=>`<option value="${pi}" ${pi===pSel? 'selected':''}>${pi}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div id="relatorio-periodo-detalhe">
                                    ${renderReportPeriodDetailHTML(pSel, finSel)}
                                </div>
                                <div class="mt-3 border-top pt-2">
                                    <div class="fw-bold mb-2">Indicadores</div>
                                    <ul class="mb-0">
                                        <li>N√≠vel de Servi√ßo: ${(computeServiceLevelTill(concluida?24:pEnd)*100).toFixed(1)}%</li>
                                        <li>Per√≠odos fechados: ${Math.max(0, pEnd-12)} de 12</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            const btn = document.getElementById('btn-export-pdf');
            if (btn) btn.addEventListener('click', () => {
                if (!concluida) { showToast('Dispon√≠vel apenas ao final da simula√ß√£o.', 'info'); return; }
                generateFinalPDF();
            });
            const sel = document.getElementById('sel-relatorio-periodo');
            if (sel) sel.addEventListener('change', (e)=>{
                reportViewPeriod = Number(e.target.value)||pEnd;
                const fin = gameData.financeiro[reportViewPeriod] || {};
                const cont = document.getElementById('relatorio-periodo-detalhe');
                if (cont) cont.innerHTML = renderReportPeriodDetailHTML(reportViewPeriod, fin);
            });
        }

        function renderReportPeriodDetailHTML(p, fin) {
            const custos = Number((fin.custosCompras||0)+(fin.custosFixos||0)+(fin.custosEstoques||0)+(fin.custosVendasPerdidas||0)+(fin.custosTerceirizacao||0)).toFixed(2);
            return `
                <ul class="mb-0">
                    <li>Per√≠odo: ${p}</li>
                    <li>Receita: R$ ${Number(fin.receitaVendas||0).toFixed(2)}</li>
                    <li>Custos: R$ ${custos}</li>
                    <li>Resultado: R$ ${Number(fin.resultadoOperacional||0).toFixed(2)}</li>
                    <li>Acumulado: R$ ${Number(fin.resultadoAcumulado||0).toFixed(2)}</li>
                </ul>`;
        }

        function computeFinalTotals(pEnd) {
            let receita = 0, custosCompras = 0, custosFixos = 0, custosEstoques = 0, custosPerdas = 0, custosTerce = 0, resultadoAcum = 0;
            for (let p = 13; p <= pEnd; p++) {
                const f = gameData.financeiro[p] || {};
                receita += Number(f.receitaVendas||0);
                custosCompras += Number(f.custosCompras||0);
                custosFixos += Number(f.custosFixos||0);
                custosEstoques += Number(f.custosEstoques||0);
                custosPerdas += Number(f.custosVendasPerdidas||0);
                custosTerce += Number(f.custosTerceirizacao||0);
                resultadoAcum = Number(f.resultadoAcumulado||resultadoAcum);
            }
            return {
                receita,
                custos: custosCompras + custosFixos + custosEstoques + custosPerdas + custosTerce,
                resultadoAcumulado: resultadoAcum
            };
        }

        // Navega√ß√£o de per√≠odo
        function changePeriod(delta) {
            const newP = Math.min(24, Math.max(13, getPeriodoAtual() + delta));
            gameData.config.periodoAtual = newP;
            saveGameData();
            updateAllDisplays();
        }

        // C√°lculos principais
        function computeCapacity(p) {
            const prod = gameData.producao[p];
            const recursos = gameData.capacidade[p];
            
            // Debug: verificar se os turnos est√£o sendo lidos corretamente
            console.log(`Per√≠odo ${p} - Turnos:`, {
                tecelagem: recursos.tecelagem.turnos,
                purgaTinturaria: recursos.purgaTinturaria.turnos,
                fixacaoAcabamento: recursos.fixacaoAcabamento.turnos
            });
            
            // Dispon√≠vel (garantir que n√£o seja NaN)
            const disp = {
                tecelagem: Math.max(0, (recursos.tecelagem.teares || 0) * (recursos.tecelagem.turnos || 0) * PROCESS_RATES.tecelagem),
                purgaTinturaria: Math.max(0, (recursos.purgaTinturaria.jets || 0) * (recursos.purgaTinturaria.turnos || 0) * PROCESS_RATES.purgaTinturaria),
                fixacaoAcabamento: Math.max(0, (recursos.fixacaoAcabamento.ramas || 0) * (recursos.fixacaoAcabamento.turnos || 0) * PROCESS_RATES.fixacaoAcabamento)
            };
            
            console.log(`Per√≠odo ${p} - Capacidade dispon√≠vel:`, disp);
            
            // Necess√°ria
            const necess = { tecelagem: 0, purgaTinturaria: 0, fixacaoAcabamento: 0 };
            PRODUCTS.forEach(k => {
                const q = prod[k].planejada || 0;
                necess.tecelagem += q * (PROCESS_WEIGHTS[k].tecelagem || 0);
                necess.purgaTinturaria += q * (PROCESS_WEIGHTS[k].purgaTinturaria || 0);
                necess.fixacaoAcabamento += q * (PROCESS_WEIGHTS[k].fixacaoAcabamento || 0);
            });
            
            console.log(`Per√≠odo ${p} - Capacidade necess√°ria:`, necess);
            
            return {
                tecelagem: { necessaria: necess.tecelagem || 0, disponivel: disp.tecelagem || 0 },
                purgaTinturaria: { necessaria: necess.purgaTinturaria || 0, disponivel: disp.purgaTinturaria || 0 },
                fixacaoAcabamento: { necessaria: necess.fixacaoAcabamento || 0, disponivel: disp.fixacaoAcabamento || 0 }
            };
        }

        function computeServiceLevelTill(p) {
            let dem = 0, vend = 0;
            for (let i=13; i<=p; i++) {
                PRODUCTS.forEach(k=>{ dem += gameData.demanda[i]?.[k]?.real || 0; vend += gameData.producao[i]?.[k]?.vendas || 0; });
            }
            return dem>0 ? vend/dem : 1;
        }

        
        // Fun√ß√£o para testar o sistema de compras de emerg√™ncia (apenas para debug)
        function debugComprasEmergencia() {
            console.log("=== DEBUG: Sistema de Compras de Emerg√™ncia ===");
            const p = getPeriodoAtual();
            
            // Estado atual dos materiais
            console.log("Estado atual dos materiais (per√≠odo " + p + "):");
            MATERIALS.forEach(m => {
                const comp = gameData.compras[p][m];
                console.log(`${m}: Estoque Inicial=${comp.estoqueInicial}, Compras Planejadas=${comp.planejada}, Compras Emerg√™ncia=${comp.comprasEmergencia || 0}, Estoque Final=${comp.estoqueFinal || 0}`);
            });
            
            // Estado da produ√ß√£o
            console.log("Estado da produ√ß√£o (per√≠odo " + p + "):");
            PRODUCTS.forEach(k => {
                const prod = gameData.producao[p][k];
                console.log(`${k}: Planejada=${prod.planejada}, Real=${prod.real || 0}, Vendas=${prod.vendas || 0}`);
            });
            
            // C√°lculo de necessidades (BOM)
            console.log("C√°lculo de necessidades de materiais:");
            MATERIALS.forEach(m => {
                let totalNecessario = 0;
                PRODUCTS.forEach(k => {
                    const qtdProd = gameData.producao[p][k].real || gameData.producao[p][k].planejada || 0;
                    const necessidade = qtdProd * (BOM[k][m] || 0);
                    if (necessidade > 0) {
                        console.log(`  ${k} ‚Üí ${m}: ${qtdProd} unidades * ${BOM[k][m]} = ${necessidade}`);
                        totalNecessario += necessidade;
                    }
                });
                console.log(`  Total necess√°rio de ${m}: ${totalNecessario}`);
            });
        }
        
        /*
         * CORRE√á√ÉO IMPLEMENTADA: Sistema de Compras de Emerg√™ncia
         * 
         * Problema identificado: O sistema estava descartando compras terceirizadas 
         * ao inv√©s de incorpor√°-las ao invent√°rio para uso futuro.
         * 
         * Solu√ß√£o implementada:
         * 1. Detecta quando h√° falta de material (consumo > estoque inicial + compras planejadas)
         * 2. Calcula automaticamente compras de emerg√™ncia para cobrir o d√©ficit
         * 3. Incorpora essas compras ao invent√°rio dispon√≠vel para uso
         * 4. Aplica custo premium (+50%) para compras de emerg√™ncia
         * 5. Separa custos de compras normais vs emerg√™ncia no relat√≥rio financeiro
         * 6. Notifica o usu√°rio quando compras de emerg√™ncia s√£o realizadas
         * 7. Exibe informa√ß√µes de compras de emerg√™ncia na interface
         * 
         * CORRE√á√ÉO ADICIONAL: Demanda Real Baseada na Previs√£o
         * 
         * Problema identificado: A demanda real era sempre baseada apenas na demanda base,
         * ignorando completamente a previs√£o inserida pelo jogador.
         * 
         * Solu√ß√£o implementada:
         * 1. Demanda real agora usa m√©dia ponderada: 70% previs√£o + 30% base hist√≥rica
         * 2. C√°lculo do erro de previs√£o (MAPE) para avaliar qualidade da previs√£o
         * 3. Interface mostra erro de previs√£o em per√≠odos fechados
         * 4. Relat√≥rio final inclui erro m√©dio de previs√£o como indicador
         * 5. Campos desabilitados para per√≠odos j√° fechados
         * 
         * Impacto: A produ√ß√£o n√£o ser√° mais limitada por falta de material, mas
         * haver√° custo adicional pelas compras n√£o planejadas. A previs√£o agora
         * influencia a demanda real, tornando o jogo mais realista e educativo.
         */
        
        function closePeriod() {
            const p = getPeriodoAtual();
            try {
                // Bloqueia ap√≥s t√©rmino
                if (gameData.config?.simulacaoConcluida || Number(gameData.config?.ultimoFechado||0) >= 24) {
                    showToast('Simula√ß√£o conclu√≠da. N√£o √© poss√≠vel fechar novos per√≠odos.', 'info');
                    updateGlobalActionsUI();
                    return;
                }
                // 1) Demanda real
                const cen = gameData.config.cenario;
                PRODUCTS.forEach(k=>{
                    const base = cen.demandaBase[p][k];
                    const previsao = gameData.demanda[p][k].prevista || 0;
                    
                    // Se h√° previs√£o, usa m√©dia ponderada entre previs√£o (70%) e base (30%)
                    // Isso simula que a previs√£o tem influ√™ncia na demanda real, mas n√£o controle total
                    const demandaEsperada = previsao > 0 ? 
                        (previsao * 0.7 + base * 0.3) : base;
                    
                    // Volatilidade composta: base (20%) √ó multiplicador espec√≠fico do produto
                    const volatilidade = cen.volatilidade || 0.2; // Volatilidade base (20%)
                    const multiplicador = cen.volatilidades?.[k] || 1.0; // Multiplicador do produto
                    const volatilityFinal = volatilidade * multiplicador; // Volatilidade composta
                    const noise = (Math.random()*2 - 1) * volatilityFinal; // -vol..+vol composta
                    const real = Math.max(0, Math.round(demandaEsperada * (1 + noise)));
                    gameData.demanda[p][k].real = real;
                    
                    // Calcular erro de previs√£o (MAPE - Mean Absolute Percentage Error)
                    if (gameData.demanda[p][k].prevista > 0) {
                        const erro = Math.abs(real - gameData.demanda[p][k].prevista) / real;
                        gameData.demanda[p][k].erroPrevisao = erro;
                    }
                });
                // 2) Compras realizadas
                MATERIALS.forEach(m=>{
                    const comp = gameData.compras[p][m];
                    comp.real = comp.planejada || 0;
                });
                // 3) Capacidade e produ√ß√£o real
                const cap = computeCapacity(p);
                const fracCap = Math.min(
                    cap.tecelagem.disponivel>0? cap.tecelagem.disponivel/Math.max(1,cap.tecelagem.necessaria):1,
                    cap.purgaTinturaria.disponivel>0? cap.purgaTinturaria.disponivel/Math.max(1,cap.purgaTinturaria.necessaria):1,
                    cap.fixacaoAcabamento.disponivel>0? cap.fixacaoAcabamento.disponivel/Math.max(1,cap.fixacaoAcabamento.necessaria):1
                );
                const frac = Math.min(1, isFinite(fracCap) ? fracCap : 1);
                PRODUCTS.forEach(k=>{
                    const planned = gameData.producao[p][k].planejada || 0;
                    const real = Math.floor(planned * frac);
                    gameData.producao[p][k].real = real;
                });
                // 4) Consumo de materiais
                let totalComprasEmergencia = 0;
                let materiaisEmergencia = [];
                MATERIALS.forEach(m=>{
                    const comp = gameData.compras[p][m];
                    let consumo = 0;
                    PRODUCTS.forEach(k=>{
                        consumo += (gameData.producao[p][k].real || 0) * (BOM[k][m]||0);
                    });
                    comp.consumoReal = consumo;
                    
                    // Calcular disponibilidade de material
                    const disponivel = (comp.estoqueInicial||0) + (comp.real||0);
                    
                    // Se h√° falta de material, realizar compras de emerg√™ncia/terceirizadas
                    if (consumo > disponivel) {
                        comp.comprasEmergencia = consumo - disponivel;
                        comp.estoqueFinal = 0; // Todo material foi consumido
                        totalComprasEmergencia += comp.comprasEmergencia;
                        materiaisEmergencia.push(`${m.toUpperCase()}: ${comp.comprasEmergencia}`);
                    } else {
                        comp.comprasEmergencia = 0;
                        comp.estoqueFinal = disponivel - consumo;
                    }
                });
                
                // Notificar sobre compras de emerg√™ncia
                if (totalComprasEmergencia > 0) {
                    showToast(`Compras de emerg√™ncia realizadas: ${materiaisEmergencia.join(', ')}. Custo premium aplicado (+50%).`, 'warning');
                }
                // 5) Vendas e estoques de produtos
                PRODUCTS.forEach(k=>{
                    const estIni = gameData.producao[p][k].estoqueInicial || 0;
                    const prodReal = gameData.producao[p][k].real || 0;
                    const demReal = gameData.demanda[p][k].real || 0;
                    const disponivel = estIni + prodReal;
                    const vendas = Math.min(disponivel, demReal);
                    const vendasPerdidas = Math.max(0, demReal - vendas);
                    const estFin = disponivel - vendas;
                    Object.assign(gameData.producao[p][k], { vendas, vendasPerdidas, estoqueFinal: estFin });
                });
                // 6) Financeiro
                computeFinance(p);
                // 7) Preparar pr√≥ximo per√≠odo
                gameData.config.ultimoFechado = p;
                if (p < 24) {
                    const next = p+1;
                    // Estoques iniciais
                    PRODUCTS.forEach(k=>{ gameData.producao[next][k].estoqueInicial = gameData.producao[p][k].estoqueFinal; });
                    MATERIALS.forEach(m=>{ gameData.compras[next][m].estoqueInicial = gameData.compras[p][m].estoqueFinal; });
                    gameData.config.periodoAtual = next;
                } else {
                    gameData.config.simulacaoConcluida = true;
                    showToast('M√≥dulo conclu√≠do. Relat√≥rio final dispon√≠vel.', 'info');
                    showSection('relatorios');
                }
                saveGameData();
                updateAllDisplays();
                updateGlobalActionsUI();
                showToast('Per√≠odo fechado com sucesso!', 'success');
            } catch (e) {
                console.error(e);
                showToast('Erro ao fechar per√≠odo: '+e.message, 'danger');
            }
        }

        function computeFinance(p) {
            const cen = gameData.config.cenario;
            const safeNum = (v, def=0) => Number.isFinite(Number(v)) ? Number(v) : def;
            const getPrice = (k) => {
                const v = cen?.precos?.[k];
                return Number.isFinite(Number(v)) && Number(v) > 0 ? Number(v) : DEFAULT_PRICES[k];
            };
            // Receitas
            let receita = 0; let perdidas = 0; let estoqueFinal = 0;
            PRODUCTS.forEach(k=>{
                const vendas = safeNum(gameData.producao[p][k].vendas, 0);
                const preco = getPrice(k);
                receita += vendas * preco;
                perdidas += safeNum(gameData.producao[p][k].vendasPerdidas, 0);
                estoqueFinal += safeNum(gameData.producao[p][k].estoqueFinal, 0);
            });
            // Compras custo
            let custoCompras = 0; let estoqueMatFinal = 0; let custoComprasEmergencia = 0;
            MATERIALS.forEach(m=>{
                custoCompras += safeNum(gameData.compras[p][m].real, 0) * safeNum(MATERIAL_COST[m], 0);
                // Compras de emerg√™ncia t√™m custo premium (multiplicador de 1.5x do custo normal)
                custoComprasEmergencia += safeNum(gameData.compras[p][m].comprasEmergencia, 0) * safeNum(MATERIAL_COST[m], 0) * 1.5;
                estoqueMatFinal += safeNum(gameData.compras[p][m].estoqueFinal, 0);
            });
            // Total de custos de compras (planejadas + emerg√™ncia)
            custoCompras += custoComprasEmergencia;
            // Custos
            const custoEstoque = (estoqueFinal + estoqueMatFinal) * safeNum(cen.custoEstoque, DEFAULT_COSTS.custoEstoque);
            const custoPerdas = safeNum(cen.penalidadePerda, DEFAULT_COSTS.penalidadePerda) * perdidas;
            
            // Custos fixos base + custos de turnos extras
            let custosFixos = safeNum(cen.custosFixos, DEFAULT_COSTS.custosFixos);
            
            // Adicionar custo por turnos extras (turnos > 1 custam R$ 500 cada)
            const capData = gameData.capacidade[p];
            const turnosExtras = Math.max(0, (capData.tecelagem.turnos || 0) - 1) +
                                Math.max(0, (capData.purgaTinturaria.turnos || 0) - 1) +
                                Math.max(0, (capData.fixacaoAcabamento.turnos || 0) - 1);
            custosFixos += turnosExtras * 500; // R$ 500 por turno extra
            
            // Terceiriza√ß√£o aproximada pela folga negativa em capacidade
            const cap = computeCapacity(p);
            const shortTec = Math.max(0, cap.tecelagem.necessaria - cap.tecelagem.disponivel);
            const shortJet = Math.max(0, cap.purgaTinturaria.necessaria - cap.purgaTinturaria.disponivel);
            const shortRam = Math.max(0, cap.fixacaoAcabamento.necessaria - cap.fixacaoAcabamento.disponivel);
            const custoTerce = (shortTec + shortJet + shortRam) * safeNum(cen.custoTerceirizacao, DEFAULT_COSTS.custoTerceirizacao);

            const resultado = receita - (custoCompras + custosFixos + custoEstoque + custoPerdas + custoTerce);
            const anterior = gameData.financeiro[p-1]?.resultadoAcumulado || 0;
            gameData.financeiro[p] = {
                custosFixos: custosFixos,
                custosCompras: custoCompras,
                custosEstoques: custoEstoque,
                custosTerceirizacao: custoTerce,
                custosCapital: 0,
                custosVendasPerdidas: custoPerdas,
                receitaVendas: receita,
                resultadoOperacional: resultado,
                resultadoAcumulado: anterior + resultado
            };
            console.debug('Financeiro per√≠odo', p, gameData.financeiro[p]);
        }
    </script>
</body>
</html>